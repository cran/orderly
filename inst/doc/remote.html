<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Rich FitzJohn" />

<meta name="date" content="2021-09-22" />

<title>orderly remotes</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">orderly remotes</h1>
<h4 class="author">Rich FitzJohn</h4>
<h4 class="date">2021-09-22</h4>



<p>Orderly supports a centralised workflow, where a central server holds the canonical version of a report. In order to make this workflow work, we need a number of things:</p>
<ul>
<li>To be able to run a report on a central server</li>
<li>To be able to get copies of reports from the central server in order to use them as dependencies of locally run reports</li>
<li>To be able to share these centrally run reports with someone</li>
</ul>
<p>To make this workflow work, we have developed some additional software.</p>
<p>First, we have a docker-based server system called <a href="https://github.com/vimc/orderly-web">OrderlyWeb</a> which can be deployed onto a server. We will communicate with this server over https using a package <a href="https://github.com/vimc/orderlyweb"><code>orderlyweb</code></a> which will follow <code>orderly</code> onto CRAN.</p>
<div id="orderlyweb" class="section level2">
<h2>OrderlyWeb</h2>
<p>The OrderlyWeb server software provides a number of things</p>
<ol style="list-style-type: decimal">
<li>A persistent copy of R running <code>orderly</code> that can run reports as needed using the <code>orderly.server::orderly_runner</code> function</li>
<li>A web server that exposes a user-friendly web portal showing versions of orderly reports and an http api (this application is written in <a href="https://kotlinlang.org">Kotlin</a>)</li>
<li>A reverse proxy used to secure the application with https</li>
</ol>
<p>A <a href="https://raw.githubusercontent.com/vimc/montagu-machine/master/docs/diagrams/OrderlyWeb%20architecture.png">diagram may help show how the pieces fit together</a></p>
<p>Getting OrderlyWeb installed requires a little work, and you will need access to an appropriate server running docker, our <a href="https://github.com/vimc/orderly-web-deploy/">python-based deployment tool</a>, and TLS certificates for the server that you are using. We recommend using <a href="https://www.vaultproject.io">vault</a> for storing certificates and any secrets used in deployment.</p>
<p>OrderlyWeb will use GitHub for authentication, the setup for which <a href="https://github.com/vimc/orderly-web/blob/master/docs/auth.md#authenticating-with-github">is described here</a>.</p>
</div>
<div id="configuring-orderly-to-talk-to-orderlyweb" class="section level2">
<h2>Configuring <code>orderly</code> to talk to OrderlyWeb</h2>
<p>Once OrderlyWeb is running, we can tell <code>orderly</code> about it by adding an appropriate setting to the <code>orderly_config.yml</code> file. For example, if you had one testing and one production instance</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">remote:</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="fu">testing:</span></a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="fu">driver:</span><span class="at"> orderlyweb::orderlyweb_remote</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="fu">args:</span></a>
<a class="sourceLine" id="cb1-5" title="5">      <span class="fu">host:</span><span class="at"> testing.example.com</span></a>
<a class="sourceLine" id="cb1-6" title="6">      <span class="fu">port:</span><span class="at"> </span><span class="dv">443</span></a>
<a class="sourceLine" id="cb1-7" title="7">      <span class="fu">token:</span><span class="at"> $GITHUB_TOKEN</span></a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="fu">production:</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="fu">driver:</span><span class="at"> orderlyweb::orderlyweb_remote</span></a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="fu">args:</span></a>
<a class="sourceLine" id="cb1-11" title="11">      <span class="fu">host:</span><span class="at"> production.example.com</span></a>
<a class="sourceLine" id="cb1-12" title="12">      <span class="fu">port:</span><span class="at"> </span><span class="dv">443</span></a>
<a class="sourceLine" id="cb1-13" title="13">      <span class="fu">token:</span><span class="at"> $GITHUB_TOKEN</span></a></code></pre></div>
<p>where <code>$GITHUB_TOKEN</code> is an environment variable that holds a <a href="https://github.com/settings/tokens">GitHub token</a> with “user” scope. The <code>testing</code> remote is listed first, and so will be the default one used in any remote-using command.</p>
</div>
<div id="interacting-with-the-remote-server" class="section level2">
<h2>Interacting with the remote server</h2>
<p>Several commands can interact with the remote server:</p>
<ul>
<li><code>orderly::orderly_run_remote</code> will run a report on a remote server, committing it immediately. This will save the log alongside the report.</li>
<li><code>orderly::orderly_pull_archive</code> will pull a version of a report from a remote server</li>
<li><code>orderly::orderly_pull_dependencies</code> will pull all the dependencies of a report from the remote server (i.e., versions of reports declared in the <code>depends:</code> section of a report)</li>
</ul>
</div>
<div id="future-developments" class="section level2">
<h2>Future developments</h2>
<p>We hope that this system will become easier to deploy in future. We use it internally on two projects with orderly archives that hold gigabytes of analyses, and it has evolved to meet our needs. If you think it might work for you but can’t get started, please get in touch.</p>
</div>
<div id="deploying-a-remote-server" class="section level2">
<h2>Deploying a remote server</h2>
<p>We recommend using <a href="https://www.vaultproject.io/">HashiCorp’s vault</a> for storing secrets (of which several are used here), and our tooling is designed to make this easy.</p>
<p>You will need to set up and/or gather a few things beforehand:</p>
<ul>
<li>SSL certificate and private key for the reverse proxy; in the example below we have stored the certificate in the vault</li>
<li>If the orderly source repository is private, <a href="https://developer.github.com/v3/guides/managing-deploy-keys/#deploy-keys">create a deploy key</a> with read-only access to your repository, and add that to the vault also</li>
<li>Create an OAuth app, following instructions <a href="https://github.com/vimc/orderly-web/blob/master/docs/auth.md#authenticating-with-github">here</a>, somewhat better instructions <a href="https://github.com/ncov-ic/setup#create-an-oauth-app">here</a></li>
<li>Create a docker image that has all of your wanted R packages and external software; this image should be based off of <code>vimc/orderly.server:master</code>, for example <a href="https://github.com/ncov-ic/ncov-orderly/blob/master/docker/Dockerfile">the Dockerfile for the coronavirus response</a> and push that to some accessible location (either docker hub or a private registry). You can initially skip this step and just use <code>vimc/orderly.server:master</code> but the set of built-in packages is very limited</li>
</ul>
<p>Create an orderly-web configuration; see <a href="https://github.com/mrc-ide/covid19-forecasts-orderly-web/blob/main/config/orderly-web.yml">here</a> for an example and <a href="https://github.com/vimc/orderly-web-deploy/blob/master/config/complete/orderly-web.yml">here</a> for a highly annotated example. A somewhat stripped down version of this looks like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">vault:</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="fu">addr:</span><span class="at"> https://vault.dide.ic.ac.uk:8200</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="fu">auth:</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="fu">method:</span><span class="at"> github</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="fu">container_prefix:</span><span class="at"> orderly_web</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="fu">network:</span><span class="at"> orderlyweb_nw</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="fu">orderly:</span><span class="at"> orderly_volume</span></a>
<a class="sourceLine" id="cb2-11" title="11">  <span class="fu">proxy_logs:</span><span class="at"> orderlyweb_proxy_logs</span></a>
<a class="sourceLine" id="cb2-12" title="12">  <span class="fu">css:</span><span class="at"> orderlywebweb_css</span></a>
<a class="sourceLine" id="cb2-13" title="13"></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="fu">orderly:</span></a>
<a class="sourceLine" id="cb2-15" title="15">  <span class="fu">image:</span></a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="fu">repo:</span><span class="at"> yourorg</span></a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="fu">name:</span><span class="at"> orderly</span></a>
<a class="sourceLine" id="cb2-18" title="18">    <span class="fu">tag:</span><span class="at"> latest</span></a>
<a class="sourceLine" id="cb2-19" title="19">  <span class="fu">initial:</span></a>
<a class="sourceLine" id="cb2-20" title="20">    <span class="fu">source:</span><span class="at"> clone</span></a>
<a class="sourceLine" id="cb2-21" title="21">    <span class="fu">url:</span><span class="at"> git@github.com:yourorg/orderly-reports</span></a>
<a class="sourceLine" id="cb2-22" title="22">  <span class="fu">ssh:</span></a>
<a class="sourceLine" id="cb2-23" title="23">    <span class="fu">public:</span><span class="at"> VAULT:secret/deploy-key:public</span></a>
<a class="sourceLine" id="cb2-24" title="24">    <span class="fu">private:</span><span class="at"> VAULT:secret/deploy-key:private</span></a>
<a class="sourceLine" id="cb2-25" title="25"></a>
<a class="sourceLine" id="cb2-26" title="26"><span class="fu">web:</span></a>
<a class="sourceLine" id="cb2-27" title="27">  <span class="fu">image:</span></a>
<a class="sourceLine" id="cb2-28" title="28">    <span class="fu">repo:</span><span class="at"> vimc</span></a>
<a class="sourceLine" id="cb2-29" title="29">    <span class="fu">name:</span><span class="at"> orderly-web</span></a>
<a class="sourceLine" id="cb2-30" title="30">    <span class="fu">tag:</span><span class="at"> master</span></a>
<a class="sourceLine" id="cb2-31" title="31">    <span class="fu">migrate:</span><span class="at"> orderlyweb-migrate</span></a>
<a class="sourceLine" id="cb2-32" title="32">    <span class="fu">admin:</span><span class="at"> orderly-web-user-cli</span></a>
<a class="sourceLine" id="cb2-33" title="33">    <span class="fu">css-generator:</span><span class="at"> orderly-web-css-generator</span></a>
<a class="sourceLine" id="cb2-34" title="34">  <span class="fu">url:</span><span class="at"> https://orderly.example.com</span></a>
<a class="sourceLine" id="cb2-35" title="35">  <span class="fu">dev_mode:</span><span class="at"> </span><span class="ch">false</span></a>
<a class="sourceLine" id="cb2-36" title="36">  <span class="fu">port:</span><span class="at"> </span><span class="dv">8888</span></a>
<a class="sourceLine" id="cb2-37" title="37">  <span class="fu">name:</span><span class="at"> Outputs</span></a>
<a class="sourceLine" id="cb2-38" title="38">  <span class="fu">email:</span><span class="at"> you@example.com</span></a>
<a class="sourceLine" id="cb2-39" title="39">  <span class="fu">auth:</span></a>
<a class="sourceLine" id="cb2-40" title="40">    <span class="fu">github_org:</span><span class="at"> yourorg</span></a>
<a class="sourceLine" id="cb2-41" title="41">    <span class="fu">github_team:</span><span class="at"> yourteam</span></a>
<a class="sourceLine" id="cb2-42" title="42">    <span class="fu">github_oauth:</span></a>
<a class="sourceLine" id="cb2-43" title="43">      <span class="fu">id:</span><span class="at"> VAULT:secret/oauth/real:id</span></a>
<a class="sourceLine" id="cb2-44" title="44">      <span class="fu">secret:</span><span class="at"> VAULT:secret/oauth/real:secret</span></a>
<a class="sourceLine" id="cb2-45" title="45">    <span class="fu">fine_grained:</span><span class="at"> </span><span class="ch">false</span></a>
<a class="sourceLine" id="cb2-46" title="46">    <span class="fu">montagu:</span><span class="at"> </span><span class="ch">false</span></a>
<a class="sourceLine" id="cb2-47" title="47"></a>
<a class="sourceLine" id="cb2-48" title="48"><span class="fu">proxy:</span></a>
<a class="sourceLine" id="cb2-49" title="49">  <span class="fu">enabled:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb2-50" title="50">  <span class="fu">ssl:</span></a>
<a class="sourceLine" id="cb2-51" title="51">    <span class="fu">certificate:</span><span class="at"> VAULT:secret/proxy/ssl_certificate:value</span></a>
<a class="sourceLine" id="cb2-52" title="52">    <span class="fu">key:</span><span class="at"> VAULT:secret/ncov/ssl_private_key:value</span></a>
<a class="sourceLine" id="cb2-53" title="53">  <span class="fu">hostname:</span><span class="at"> ncov.dide.ic.ac.uk</span></a>
<a class="sourceLine" id="cb2-54" title="54">  <span class="fu">port_http:</span><span class="at"> </span><span class="dv">80</span></a>
<a class="sourceLine" id="cb2-55" title="55">  <span class="fu">port_https:</span><span class="at"> </span><span class="dv">443</span></a>
<a class="sourceLine" id="cb2-56" title="56">  <span class="fu">image:</span></a>
<a class="sourceLine" id="cb2-57" title="57">    <span class="fu">repo:</span><span class="at"> vimc</span></a>
<a class="sourceLine" id="cb2-58" title="58">    <span class="fu">name:</span><span class="at"> orderly-web-proxy</span></a>
<a class="sourceLine" id="cb2-59" title="59">    <span class="fu">tag:</span><span class="at"> master</span></a></code></pre></div>
<p>You need to install the <code>orderly-web</code> deployment scripts from <a href="https://pypi.org/project/orderly-web/">PyPi</a></p>
<pre><code>pip3 install --user orderly-web</code></pre>
<p>With all that done, running</p>
<pre><code>orderly-web start .</code></pre>
<p>should bring everything up!</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
